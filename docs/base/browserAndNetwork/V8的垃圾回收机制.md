# V8 的垃圾回收机制

JavaScript 中的数据存储分为堆存储和栈存储。堆存储用于存储对象，栈存储用于存储基本类型的数据。

V8 引擎的垃圾回收机制主要针对堆存储进行管理。

## 栈的垃圾回收机制

栈通过移动 ESP 指针（记录当前执行位置的指针）实现内存管理。

在执行栈中，当函数执行结束后，JS 引擎通过向下移动 ESP 指针来销毁函数保存在栈中的执行上下文。

## 堆的垃圾回收机制（Garbage Collection， GC）

V8 引擎将对象存储在堆（Heap）中，并将堆划分为新生代和老生代，分别使用不同的 GC 策略。

| 内存区域                   | 特点                                           | 回收策略                        |
| -------------------------- | ---------------------------------------------- | ------------------------------- |
| 新生代（Young Generation） | 存放存活时间短的小对象（如局部变量、临时对象） | Scavenge 算法                   |
| 老生代（Old Generation）   | 存放存活时间长或较大的对象（如全局变量、闭包） | Mark-Sweep 和 Mark-Compact 算法 |

:::tip 对象的生命周期

1. 新创建的对象优先存入新生代（小对象）。
2. 对象在新生代存活一定时间后，会被移动到老生代。（晋升）
3. 老生代的对象会被增量标记-清除（Mark-Sweep & Mark-Compact）。

:::

### 新生代垃圾回收（Scavenge 算法）

Scavenge 算法将堆内存分为两个大小相等的区域：对象区域和空闲区域。

具体垃圾回收过程如下：

- 遍历对象区域，标记存活的对象。
- 将存活的对象复制到空闲区域，并有序排列（避免碎片化）。
- 将对象区域和空闲区域进行角色翻转。

:::tip 对象从新生代晋升到老生代条件

1. 在新生代存活超过两次 GC。
2. 空闲区域空间使用率超过 25%时，部分对象会提前晋升。

:::

### 老生代垃圾回收（Mark-Sweep & Mark-Compact 算法）

老生代存放生命周期较长的大对象，V8 使用 Maek-Sweep 和 Mark-Compact 算法进行垃圾回收。具体过程如下：

#### Mark-Sweep 算法（标记-清除）

- 标记：从根对象出发，递归遍历所有可到达的对象，并标记为存活；未被标记的对象即为不可到达的对象（垃圾）。
- 清除：清除未被标记的对象，释放内存。

缺点：会产生内存碎片，影响后续内存分配。

#### Mark-Compact 算法（标记-整理）

- 标记：标记存活对象。
- 整理：将存活对象移动到连续的内存区域。
- 清除：释放无用对象。

## 触发垃圾回收的场景

V8 何时触发垃圾回收？

1. 新生代堆满（超过 64MB ～ 128MB）。
2. 老生代堆满（超过 700MB ～ 1.4GB）。
3. 主动调用`global.gc()`（Node.js 需要`--expose-gc`参数）。
