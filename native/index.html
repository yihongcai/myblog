<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>小程序架构 | VuePress</title><meta name="description" content="My first VuePress Site">
    <link rel="stylesheet" href="/myblog/assets/css/styles.ee738fc2.css">
    <link rel="preload" href="/myblog/assets/js/runtime~app.8e456b83.js" as="script"><link rel="preload" href="/myblog/assets/css/styles.ee738fc2.css" as="style"><link rel="preload" href="/myblog/assets/js/399.0bea203a.js" as="script"><link rel="preload" href="/myblog/assets/js/app.9cc99adf.js" as="script">
    <link rel="prefetch" href="/myblog/assets/js/base_javascript_异步编程方案.html.bfff2172.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_browserAndNetwork_跨标签页通信.html.dd601462.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_index.html.f24ca21d.js" as="script"><link rel="prefetch" href="/myblog/assets/js/code_leetcode_滑动窗口.html.6e70c2f3.js" as="script"><link rel="prefetch" href="/myblog/assets/js/framework_vue_index.html.f3b21a2a.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_browserAndNetwork_同源策略和跨域.html.cf95e354.js" as="script"><link rel="prefetch" href="/myblog/assets/js/framework_react_index.html.875c15fb.js" as="script"><link rel="prefetch" href="/myblog/assets/js/native_index.html.09c65a7e.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_browserAndNetwork_V8的垃圾回收机制.html.cf6a9546.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_this指向.html.28fe6bf4.js" as="script"><link rel="prefetch" href="/myblog/assets/js/get-started.html.71ab6783.js" as="script"><link rel="prefetch" href="/myblog/assets/js/devops_newTechnology_现代Web框架.html.ebf3e028.js" as="script"><link rel="prefetch" href="/myblog/assets/js/devops_newTechnology_现代Web服务器.html.f361977c.js" as="script"><link rel="prefetch" href="/myblog/assets/js/devops_newTechnology_index.html.1e1dec3a.js" as="script"><link rel="prefetch" href="/myblog/assets/js/ai_index.html.e4efeefa.js" as="script"><link rel="prefetch" href="/myblog/assets/js/index.html.98ecd891.js" as="script"><link rel="prefetch" href="/myblog/assets/js/devops_index.html.b33e1d92.js" as="script"><link rel="prefetch" href="/myblog/assets/js/framework_index.html.46288221.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_browserAndNetwork_index.html.aed9f84b.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_browserAndNetwork_浏览器缓存机制.html.4b1efe9b.js" as="script"><link rel="prefetch" href="/myblog/assets/js/code_leetcode_数组和字符串.html.31906e7d.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_原型和原型链.html.12a8f7ca.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_函数柯里化.html.4d962a55.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_typeof和instanceof.html.6cd21963.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_作用域链.html.ba284363.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_箭头函数.html.ffa5a145.js" as="script"><link rel="prefetch" href="/myblog/assets/js/base_javascript_继承.html.71e73cea.js" as="script"><link rel="prefetch" href="/myblog/assets/js/code_index.html.eb35b9a8.js" as="script"><link rel="prefetch" href="/myblog/assets/js/code_programme_index.html.d8f03c88.js" as="script"><link rel="prefetch" href="/myblog/assets/js/code_leetcode_index.html.22284132.js" as="script"><link rel="prefetch" href="/myblog/assets/js/category_index.html.6d9876b6.js" as="script"><link rel="prefetch" href="/myblog/assets/js/timeline_index.html.95c81e45.js" as="script"><link rel="prefetch" href="/myblog/assets/js/404.html.555b1054.js" as="script"><link rel="prefetch" href="/myblog/assets/js/article_index.html.7f1a85ab.js" as="script"><link rel="prefetch" href="/myblog/assets/js/tag_index.html.1ebe591c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/myblog/"><img class="vp-site-logo" src="https://vuejs.press/images/hero.png" alt="VuePress"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">VuePress</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/base/" aria-label="前端基础"><!--[--><!--[--><!--]--><!--]-->前端基础<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/framework/" aria-label="前端框架"><!--[--><!--[--><!--]--><!--]-->前端框架<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/devops/" aria-label="前端工程化"><!--[--><!--[--><!--]--><!--]-->前端工程化<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/myblog/native/" aria-label="跨端"><!--[--><!--[--><!--]--><!--]-->跨端<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/code/" aria-label="算法编程"><!--[--><!--[--><!--]--><!--]-->算法编程<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/ai/" aria-label="AI"><!--[--><!--[--><!--]--><!--]-->AI<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/yihongcai/myblog" aria-label="Github" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->Github<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/base/" aria-label="前端基础"><!--[--><!--[--><!--]--><!--]-->前端基础<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/framework/" aria-label="前端框架"><!--[--><!--[--><!--]--><!--]-->前端框架<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/devops/" aria-label="前端工程化"><!--[--><!--[--><!--]--><!--]-->前端工程化<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/myblog/native/" aria-label="跨端"><!--[--><!--[--><!--]--><!--]-->跨端<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/code/" aria-label="算法编程"><!--[--><!--[--><!--]--><!--]-->算法编程<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/myblog/ai/" aria-label="AI"><!--[--><!--[--><!--]--><!--]-->AI<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/yihongcai/myblog" aria-label="Github" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->Github<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading active" href="/myblog/native/miniProgram/" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/myblog/native/" aria-label="小程序架构"><!--[--><!--[--><!--]--><!--]-->小程序架构<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="小程序架构" tabindex="-1"><a class="header-anchor" href="#小程序架构"><span>小程序架构</span></a></h1><h2 id="双线程架构" tabindex="-1"><a class="header-anchor" href="#双线程架构"><span>双线程架构</span></a></h2><p>小程序为双线程架构模型，渲染层和逻辑层分别由两个线程管理。渲染层使用 webview 渲染，逻辑层采用 jsCore 运行 javascript 代码。</p><p>小程序的架构图如下： <img src="/myblog/assets/img/miniprogram.df11962f.png" alt="小程序架构"> 从图中可以看出，由于逻辑层和渲染层分开，一个小程序有多个界面，所以渲染层对应存在多个 webview。这两个线程之间的通信由 native 层进行统一处理。<span style="color:red;">无论是线程之间的通讯、数据的传递、网络请求都由 native 层做转发。</span></p><p>逻辑层、渲染层和 native 层负责的功能如下：</p><ul><li>逻辑层：创建了一个单独的线程去执行 javascript，在这个环境下执行的都是小程序业务逻辑相关的代码。</li><li>渲染层：界面渲染相关的任务全都在 webview 线程中执行，通过逻辑层代码去控制渲染哪些页面。一个小程序存在多个界面，所以渲染层存在多个 webview 线程。</li><li>native 层：逻辑层和渲染层之间的通信会经由微信客户端（native）做中转，逻辑层发送网络请求也经由 native 转发。</li></ul><p>逻辑层运行在 jsCore 中，并没有一个完整浏览器对象，因为缺少相关的 dom api 和 bom api，无法操作页面元素，能达到管控的目的，但也限制了开发者的权限。</p><ul><li>不允许开发者把页面跳转到其他在线页面。</li><li>不允许开发者直接访问 dom。</li><li>不允许开发者随意使用 window 上的某些未知的可能有危险的 api。</li></ul><p>逻辑层与 ui 层完全隔离，加上以上的开发限制和小程序的审核和举报机制，使得微信可以加强对小程序的管控。</p><h2 id="webview-是什么-为什么要创建多个-webview" tabindex="-1"><a class="header-anchor" href="#webview-是什么-为什么要创建多个-webview"><span>webview 是什么？为什么要创建多个 webview？</span></a></h2><p>webview 可以看作是一个嵌入式的浏览器，是嵌入在原声应用中的。webview 使用 webkit 渲染引擎来展示网页中的 view 组件，并且支持前进后退、浏览历史、放大缩小等功能。</p><p>为什么要做多个 webview？<span style="color:red;">为了更加接近原生应用 app 的用户体验。</span></p><p>多个 webview 可以理解为多页面应用，有别于单页面应用 spa。spa 渲染页面是通过路由识别，随后动态将页面挂载到 root 节点中去，在单页面应用中打开一个新的页面，需要先卸载掉当前页面结构并重新渲染。</p><p>很显然原生 app 并不是这个样子，比较明显的特征为从页面右侧向左划入一个新的页面，并且我们可以同时看到两个页面。多页面应用就很好达到这个效果，新页面直接滑出来并且覆盖在旧页面上即可，这也是小程序现在的实现形式。这样的好处是页面切换更加流畅，用户体验更好。</p><h2 id="双线程模型的优缺点" tabindex="-1"><a class="header-anchor" href="#双线程模型的优缺点"><span>双线程模型的优缺点</span></a></h2><p>优点</p><ul><li>将逻辑层和渲染层隔离开，用户无法直接操作 dom，提供了相对封闭和安全的运行环境。</li><li>js 执行不会阻塞或干扰 webview 渲染，但是大部分情况下视图都要依赖 js 中处理的数据，js 如果被阻塞就不会通知视图去更新，这条优点意义不大。所以小程序官方提出了初始渲染缓存，缓存初始 data 的渲染结果并展示给用户。</li><li>所有的页面和组件的逻辑都在一个线程（app service）中运行，使用同一个上下文环境，比较好做状态共享和跨页面通讯。</li></ul><p>缺点</p><ul><li>每一次数据传递都要进行一次线程之间的通信，业务逻辑层和渲染层天然隔离，造成通信开销大、延迟高等问题，通信越频繁、数据量越大，则性能瓶颈越严重。</li><li>每个页面都创建一个 webview 线程处理，有更多的内存、时间开销。</li><li>渲染层和逻辑层状态要维护两份，进一步加重内存、时间开销，并且没有办法保证两份数据实时保持一致，例如仅使用 this.data 更新数据而不是通过 setData 时，那么实际渲染的值与逻辑层的值就不一致，某些场景下会造成非预期的问题。</li></ul><p>从开发者的角度来看，小程序的双线程模型架构并不是一个很好的架构，逻辑层与渲染层隔离，带来的问题远远比它解决的问题更多。除了状态共享和跨页面通信外，几乎对开发者来说没啥吸引力。相对于状态共享和跨页面通信，我们当然更关心当前页面的渲染效率（性能）。</p><p>但是从微信的角度来说，他们想在享受 web 生态的好处的同时也能限制 web 的开放性，增强自己对平台内容的管控，从禁用 eval 和 new Function()就能看出一二。</p><p>当然微信也知道架构所带来的性能问题，所以发明了 wxs，让一部分 js 代码能在渲染层跑，部分解决通信消耗和延迟的问题，只能满足很小一部分场景，依旧很鸡肋。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated:: </span><time class="meta-item-info" datetime="2025-04-15T07:37:50.000Z" data-allow-mismatch>4/15/25, 7:37 AM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: caiyihong@baidu.com">caiyihong</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/myblog/assets/js/runtime~app.8e456b83.js" defer></script><script src="/myblog/assets/js/399.0bea203a.js" defer></script><script src="/myblog/assets/js/app.9cc99adf.js" defer></script>
  </body>
</html>
